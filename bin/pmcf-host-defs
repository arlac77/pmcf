#!/usr/bin/env node

import { join } from "node:path";
import { types } from "pmcf";
import { prepare } from "../src/cmd.mjs";
import {
  generateNetworkDefs,
  generateMachineInfo,
  copySshKeys,
  generateKnownHosts
} from "../src/host-utils.mjs";

const { root, args, options } = await prepare();

const hostName = args[0];

const host = await root.load(hostName, { type: types.host });

await generateNetworkDefs(host, options.output);
await generateMachineInfo(host, options.output);
await copySshKeys(host, options.output);
await generateKnownHosts(
  host.owner.hosts(),
  join(options.output, "root", ".ssh")
);

console.log("provides", "host", ...host.provides);
console.log("depends", `location-${host.location.name}`, ...host.depends);
console.log("replaces", `mf-${host.hostName}`, ...host.replaces);
console.log("description", `host definitions for ${host.domainName}`);
console.log("backup", "root/.ssh/known_hosts");
